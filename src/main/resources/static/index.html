<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
<script type="application/javascript" src="https://cdn.bootcss.com/sockjs-client/1.1.4/sockjs.min.js"></script>
<script type="application/javascript" src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    //最大重连次数
    let maxLen = 10;
    //当前重连次数
    let currentLen = 0;

    function connectWebSocket() {
        let socket = new SockJS('http://127.0.0.1:8080/endpoint');
        stompClient = Stomp.over(socket);
        stompClient.connect(getHeaders(),
            // 连接成功回调函数
            frame => {
                console.log('服务端 Socket 连接建立');

                // 获取 websocket 连接的 sessionId
                const sessionId = /\/([^\/]+)\/websocket/.exec(socket._transport.url)[1];
                console.log("connected, session id: " + sessionId);

                // 订阅广播消息（服务端单向推送）
                stompClient.subscribe('/topic/broadcasting/unidirectional/allClient',
                    (response) => {
                        console.log(`[广播（服务端单向推送）]: ${response.body}`)
                    });

                // 订阅广播消息（双向通信）
                stompClient.subscribe('/topic/broadcasting/bilateral/allClient', res => {
                    console.log(`[广播（双向通信）]: ${res.body}`)
                });

                // 订阅私人消息（双向通信）
                stompClient.subscribe(`/user/${sessionId}/push/bilateral/thisClient`, res => {
                    console.log(`[点对点推送（双向通信）]: ${res.body}`)
                });

                // 订阅私人消息（单向通信）
                stompClient.subscribe(`/user/${sessionId}/push/unidirectional/thisClient`, res => {
                    console.log(`[点对点推送（单向通信）]：${res.body}`);
                });

                // 订阅返回复杂类型的消息
                stompClient.subscribe('/topic/complexMessage/allClient', res => {
                    console.log('订阅复杂类型类型的返回消息：{}', JSON.parse(res.body))
                });

                send();

            }, error => {
                if (currentLen < maxLen) {
                    console.log('Socket 连接失败，将在 3s 后重试');
                    setTimeout(() => connectWebSocket(), 3000)
                } else {
                    console.log('Socket 连接失败次数过多，将不再重试')
                }
                currentLen++;
            });
    }

    connectWebSocket();

    function send() {
        // 发送一个消息到服务端
        var headers = getHeaders();
        var body = {
            'message': '消息内容'
        };
        stompClient.send("/talk", headers, JSON.stringify(body));

        // 发送一个消息到客户端并且只向当前 session 通信
        stompClient.send('/speak', headers, JSON.stringify(body))

        // 发送一个复杂类型的消息
        stompClient.send('/complexMessage', headers, JSON.stringify({
            id: 17,
            name: 'rxliuli',
            sex: false
        }))
    }

    /**
     * 监听窗口关闭事件，窗口关闭前，主动关闭连接，防止连接还没断开就关闭窗口，server 端会抛异常
     */
    window.onbeforeunload = function () {
        if (stompClient !== null) {
            stompClient.disconnect(getHeaders(),);
            socket.close();
        }
        console.log('断开连接');
    };

    /**
     * 获取一个认证的 headers 信息
     * @return {{"X-Requested-With": string, Authorization: any}} 含有认证信息的 headers 对象
     */
    function getHeaders() {
        return {
            'X-Requested-With': 'X-Requested-With',
            'Authorization': localStorage.token
        }
    }
</script>
</body>

</html>